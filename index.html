<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penjadwalan Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Impor Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: center;
            vertical-align: top;
        }
        .schedule-table th {
            background-color: #f9fafb;
        }
        .notification-toast {
            animation: slide-in 0.5s forwards, fade-out 0.5s 4.5s forwards;
        }
        @keyframes slide-in {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes fade-out {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Container Utama -->
    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">

        <!-- Halaman Login -->
        <div id="login-page" class="w-full max-w-md">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-700">Login Akun</h1>
                    <p class="text-gray-500 mt-2">Selamat datang kembali!</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-600 mb-2">Username</label>
                        <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan username Anda" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-600 mb-2">Password</label>
                        <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan password Anda" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold">Login</button>
                    <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
                </form>
            </div>
             <p class="text-center text-gray-500 text-xs mt-4">
                &copy;2025 Aplikasi Penjadwalan.
            </p>
        </div>
        
        <!-- Halaman Pilih Kelas -->
        <div id="class-selection-page" class="hidden w-full max-w-md">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-700">Pilih Kelas</h1>
                    <p class="text-gray-500 mt-2">Pilih kelas yang ingin Anda lihat atau edit.</p>
                </div>
                <div id="class-buttons-container" class="space-y-4">
                    <!-- Tombol kelas akan dibuat oleh JS -->
                </div>
                <button id="selection-logout-btn" class="mt-8 w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-300 font-semibold">Logout</button>
            </div>
        </div>


        <!-- Dashboard Admin -->
        <div id="admin-dashboard" class="hidden w-full max-w-6xl">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <header class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b gap-4">
                    <h2 id="admin-dashboard-title" class="text-2xl font-bold text-gray-700">Dashboard Admin</h2>
                    <div>
                        <button id="admin-back-to-selection-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300 text-sm font-medium">Pilih Kelas Lain</button>
                        <button id="admin-logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 text-sm font-medium ml-2">Logout</button>
                    </div>
                </header>
                
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Kelola Data Siswa</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-8">
                    <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="student-fullname" class="block text-sm font-medium text-gray-600 mb-1">Nama Lengkap</label>
                            <input type="text" id="student-fullname" placeholder="Contoh: Budi Santoso" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <div>
                            <label for="student-username" class="block text-sm font-medium text-gray-600 mb-1">Username</label>
                            <input type="text" id="student-username" placeholder="Contoh: budi" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <div>
                            <label for="student-password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                            <input type="text" id="student-password" placeholder="Password untuk siswa" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold text-sm h-10">Tambah Siswa</button>
                    </form>
                    <p id="student-form-error" class="text-red-500 text-sm mt-2"></p>
                    <div class="overflow-x-auto mt-4">
                        <table class="w-full schedule-table text-sm">
                              <thead>
                                <tr>
                                    <th>Nama Lengkap</th>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body">
                                <!-- Daftar siswa akan di-generate oleh JS -->
                            </tbody>
                        </table>
                    </div>
                </div>


                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Pelajaran</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full schedule-table" id="admin-schedule-table"></table>
                </div>

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Piket</h3>
                 <div class="overflow-x-auto mb-8">
                    <table class="w-full schedule-table" id="admin-piket-table"></table>
                </div>

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Struktur Organisasi Kelas</h3>
                <div id="admin-organisasi-container" class="bg-gray-50 p-4 rounded-lg"></div>

                <div class="mt-8 text-right">
                    <button id="save-schedule-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-300 font-semibold">Simpan Perubahan Info Kelas</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Siswa -->
        <div id="student-dashboard" class="hidden w-full max-w-6xl">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                 <header class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b gap-4">
                    <h2 id="student-dashboard-title" class="text-2xl font-bold text-gray-700">Informasi Kelas</h2>
                    <div>
                        <button id="student-back-to-selection-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300 text-sm font-medium">Pilih Kelas Lain</button>
                        <button id="student-logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 text-sm font-medium ml-2">Logout</button>
                    </div>
                </header>
                <!-- Notifikasi Perubahan Jadwal -->
                <div id="notification-area" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-6 hidden" role="alert">
                  <p class="font-bold">Pemberitahuan</p>
                  <p id="notification-message">Jadwal dan info kelas ini baru saja diperbarui oleh admin.</p>
                </div>

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Pelajaran</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full schedule-table" id="student-schedule-table"></table>
                </div>
                
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Piket</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full schedule-table" id="student-piket-table"></table>
                </div>

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Struktur Organisasi Kelas</h3>
                <div id="student-organisasi-container" class="bg-gray-50 p-4 rounded-lg"></div>
            </div>
        </div>

    </div>

    <!-- Container untuk notifikasi toast -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GANTI DENGAN KUNCI SUPABASE ANDA ---
            const SUPABASE_URL = 'https://uhywvvlofvmdnmjwdmcu.supabase.co'; // Ganti dengan URL Proyek Anda
            
            // KUNCI SEBELUMNYA TIDAK VALID. HARAP SALIN KEMBALI KUNCI DARI DASHBOARD SUPABASE ANDA.
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoeXd2dmxvZnZtZG5tandkbWN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0Nzk5NzAsImV4cCI6MjA3NjA1NTk3MH0.OUUFKGviz-qqLcS6kVkX0HEZcFPJ_Rj3OJQhUBg1jeg'; // Ganti dengan Kunci Anon Anda
            
            // --- State Aplikasi ---
            let db; // Akan diinisialisasi nanti
            const { createClient } = supabase;
            let currentUser = null;
            let currentClass = null;
            let realtimeChannel = null;

            // --- DOM Elements ---
            const appContainer = document.getElementById('app-container');
            const loginPage = document.getElementById('login-page');
            const classSelectionPage = document.getElementById('class-selection-page');
            const adminDashboard = document.getElementById('admin-dashboard');
            const studentDashboard = document.getElementById('student-dashboard');
            const loginForm = document.getElementById('login-form');
            const addStudentForm = document.getElementById('add-student-form');
            const classButtonsContainer = document.getElementById('class-buttons-container');
            const loginError = document.getElementById('login-error');
            const studentFormError = document.getElementById('student-form-error');
            const selectionLogoutBtn = document.getElementById('selection-logout-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const studentLogoutBtn = document.getElementById('student-logout-btn');
            const adminBackToSelectionBtn = document.getElementById('admin-back-to-selection-btn');
            const studentBackToSelectionBtn = document.getElementById('student-back-to-selection-btn');
            const saveScheduleBtn = document.getElementById('save-schedule-btn');
            const adminScheduleTable = document.getElementById('admin-schedule-table');
            const studentScheduleTable = document.getElementById('student-schedule-table');
            const adminPiketTable = document.getElementById('admin-piket-table');
            const studentPiketTable = document.getElementById('student-piket-table');
            const adminOrganisasiContainer = document.getElementById('admin-organisasi-container');
            const studentOrganisasiContainer = document.getElementById('student-organisasi-container');
            const studentListBody = document.getElementById('student-list-body');
            const adminDashboardTitle = document.getElementById('admin-dashboard-title');
            const studentDashboardTitle = document.getElementById('student-dashboard-title');
            const notificationArea = document.getElementById('notification-area');
            const toastContainer = document.getElementById('toast-container');

            // --- Functions ---
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `notification-toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 5000);
            }
            
            async function renderStudentManagement() {
                studentListBody.innerHTML = '<tr><td colspan="4" class="p-4">Memuat data...</td></tr>';
                const { data: students, error } = await db.from('users').select('*').eq('role', 'siswa');
                if (error) {
                    showToast('Gagal memuat data siswa.', 'error');
                    console.error(error);
                    return;
                }
                studentListBody.innerHTML = '';
                students.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2 border">${student.fullname}</td>
                        <td class="p-2 border">${student.username}</td>
                        <td class="p-2 border">${student.password}</td>
                        <td class="p-2 border">
                            <button data-username="${student.username}" class="delete-student-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600">Hapus</button>
                        </td>
                    `;
                    studentListBody.appendChild(tr);
                });
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', handleDeleteStudent);
                });
            }

            function renderSchedule(tableElement, isAdmin, scheduleData) {
                if (!scheduleData) {
                     tableElement.innerHTML = '<tbody><tr><td class="p-4">Data jadwal tidak tersedia.</td></tr></tbody>'; return;
                }
                const days = Object.keys(scheduleData);
                if (days.length === 0) {
                    tableElement.innerHTML = '<tbody><tr><td class="p-4">Jadwal belum diatur.</td></tr></tbody>'; return;
                }
                const times = Object.keys(scheduleData[days[0]] || {}).sort();
                if (times.length === 0) { tableElement.innerHTML = '<tbody><tr><td class="p-4">Jadwal belum diatur.</td></tr></tbody>'; return; }
                let html = '<thead><tr><th class="w-1/12">Waktu</th>';
                days.forEach(day => html += `<th>${day}</th>`);
                html += '</tr></thead><tbody>';
                times.forEach(time => {
                    html += `<tr>`;
                    if (isAdmin) {
                        html += `<td><input type="text" value="${time}" class="w-full text-center border rounded px-1 font-semibold text-sm" data-old-time="${time}"></td>`;
                    } else {
                        html += `<td class="font-semibold text-sm">${time}</td>`;
                    }
                    days.forEach(day => {
                        const cellData = scheduleData[day]?.[time] || { subject: '', teacher: '' };
                        if (isAdmin) {
                            html += `<td>
                                <input type="text" value="${cellData.subject}" class="w-full text-center border rounded px-1 text-sm" data-day="${day}" data-time="${time}" data-field="subject" placeholder="Pelajaran">
                                <input type="text" value="${cellData.teacher}" class="w-full text-center border rounded px-1 mt-1 text-xs text-gray-600" data-day="${day}" data-time="${time}" data-field="teacher" placeholder="Guru">
                            </td>`;
                        } else {
                            html += `<td>
                                <div class="font-semibold text-sm">${cellData.subject}</div>
                                <div class="text-xs text-gray-500">${cellData.teacher}</div>
                            </td>`;
                        }
                    });
                    html += '</tr>';
                });
                html += '</tbody>';
                tableElement.innerHTML = html;
            }

            function renderPiketSchedule(tableElement, isAdmin, piketData) {
                 if (!piketData) {
                     tableElement.innerHTML = '<tbody><tr><td class="p-4">Data piket tidak tersedia.</td></tr></tbody>'; return;
                }
                const days = Object.keys(piketData);
                let html = '<thead><tr>';
                days.forEach(day => html += `<th>${day}</th>`);
                html += '</tr></thead><tbody><tr>';
                days.forEach(day => {
                    const names = piketData[day] || '';
                    if (isAdmin) {
                        html += `<td><textarea data-day="${day}" class="w-full h-32 p-2 border rounded text-sm text-center">${names}</textarea></td>`;
                    } else {
                        html += `<td class="text-sm leading-relaxed">${names.replace(/\n/g, '<br>')}</td>`;
                    }
                });
                html += '</tr></tbody>';
                tableElement.innerHTML = html;
            }

            function renderOrganisasi(containerElement, isAdmin, organisasiData) {
                 if (!organisasiData) {
                     containerElement.innerHTML = '<p>Data organisasi tidak tersedia.</p>'; return;
                }
                const positions = [ { id: 'ketua', label: 'Ketua Kelas' }, { id: 'wakil', label: 'Wakil Ketua Kelas' }, { id: 'sekretaris1', label: 'Sekretaris 1' }, { id: 'sekretaris2', label: 'Sekretaris 2' }, { id: 'bendahara1', label: 'Bendahara 1' }, { id: 'bendahara2', label: 'Bendahara 2' }, { id: 'kesenian1', label: 'Seksi Kesenian 1' }, { id: 'kesenian2', label: 'Seksi Kesenian 2' }, { id: 'pendidikan1', label: 'Seksi Pendidikan 1' }, { id: 'pendidikan2', label: 'Seksi Pendidikan 2' }, { id: 'kebersihan1', label: 'Seksi Kebersihan 1' }, { id: 'kebersihan2', label: 'Seksi Kebersihan 2' }];
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                positions.forEach(pos => {
                    const name = organisasiData[pos.id] || '';
                    html += `<div class="bg-white p-3 rounded-lg border">`;
                    if (isAdmin) {
                        html += `
                            <label for="org-${pos.id}" class="block text-sm font-medium text-gray-600">${pos.label}</label>
                            <input type="text" id="org-${pos.id}" data-position="${pos.id}" value="${name}" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded-md text-sm">
                        `;
                    } else {
                        html += `
                            <p class="text-sm font-medium text-gray-600">${pos.label}</p>
                            <p class="font-semibold text-gray-800">${name || '-'}</p>
                        `;
                    }
                    html += `</div>`;
                });
                html += '</div>';
                containerElement.innerHTML = html;
            }

            async function saveAdminChanges() {
                if (!currentClass) return;
                
                // Construct data objects from form inputs
                const newScheduleData = {};
                const newPiketData = {};
                const newOrganisasiData = {};
                
                const days = Object.keys(currentClass.data.schedule_data);
                const timeInputs = adminScheduleTable.querySelectorAll('input[data-old-time]');
                timeInputs.forEach(timeInput => {
                    const oldTime = timeInput.dataset.oldTime;
                    const newTime = timeInput.value.trim();
                    if (!newTime) return;
                    days.forEach(day => {
                        const subjectInput = adminScheduleTable.querySelector(`input[data-day="${day}"][data-time="${oldTime}"][data-field="subject"]`);
                        const teacherInput = adminScheduleTable.querySelector(`input[data-day="${day}"][data-time="${oldTime}"][data-field="teacher"]`);
                        if (subjectInput && teacherInput) {
                            if (!newScheduleData[day]) newScheduleData[day] = {};
                            newScheduleData[day][newTime] = { subject: subjectInput.value, teacher: teacherInput.value };
                        }
                    });
                });
                adminPiketTable.querySelectorAll('textarea').forEach(textarea => { newPiketData[textarea.dataset.day] = textarea.value; });
                adminOrganisasiContainer.querySelectorAll('input').forEach(input => { newOrganisasiData[input.dataset.position] = input.value; });

                // Update data in Supabase
                const { error } = await db.from('class_data')
                    .update({
                        schedule_data: newScheduleData,
                        piket_data: newPiketData,
                        organization_data: newOrganisasiData
                    })
                    .eq('class_id', currentClass.id);

                if (error) {
                    showToast('Gagal menyimpan perubahan.', 'error');
                    console.error(error);
                } else {
                    showToast('Perubahan berhasil disimpan!');
                    // Update local state to reflect changes immediately
                    currentClass.data.schedule_data = newScheduleData;
                    currentClass.data.piket_data = newPiketData;
                    currentClass.data.organization_data = newOrganisasiData;
                }
            }
            
            function showPage(page) {
                [loginPage, classSelectionPage, adminDashboard, studentDashboard].forEach(p => p.classList.add('hidden'));
                if (page) page.classList.remove('hidden');
            }
            
            async function logout() {
                if (realtimeChannel) {
                    await db.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }
                currentUser = null;
                currentClass = null;
                sessionStorage.clear();
                showPage(loginPage);
            }
            
            async function showDashboard(classInfo) {
                currentClass = classInfo;
                sessionStorage.setItem('selectedClassId', classInfo.id);

                // Fetch the detailed class data
                const { data, error } = await db.from('class_data')
                    .select('*')
                    .eq('class_id', classInfo.id)
                    .single(); // We expect only one row

                if (error || !data) {
                    // Cek error spesifik jika tabel tidak ditemukan
                    if (error && error.code === 'PGRST205') {
                        appContainer.innerHTML = `
                            <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                                <h1 class="text-2xl font-bold text-red-600 mb-4">Error: Tabel Tidak Ditemukan</h1>
                                <p class="text-gray-700 mb-2">Aplikasi tidak dapat menemukan tabel <code class="bg-gray-200 p-1 rounded">'class_data'</code> di database Anda.</p>
                                <p class="text-gray-700">Pastikan Anda telah menjalankan skrip SQL dari file <code class="bg-gray-200 p-1 rounded">supabase_setup_guide.md</code> di <strong>SQL Editor</strong> Supabase untuk membuat semua tabel yang diperlukan.</p>
                            </div>
                        `;
                        return;
                    }
                    showToast('Gagal memuat data kelas.', 'error');
                    console.error(error);
                    return;
                }
                currentClass.data = data; // Store detailed data

                if (currentUser.role === 'admin') {
                    adminDashboardTitle.textContent = `Dashboard Admin - Kelas ${classInfo.name.toUpperCase()}`;
                    await renderStudentManagement();
                    renderSchedule(adminScheduleTable, true, data.schedule_data);
                    renderPiketSchedule(adminPiketTable, true, data.piket_data);
                    renderOrganisasi(adminOrganisasiContainer, true, data.organization_data);
                    showPage(adminDashboard);
                } else {
                    studentDashboardTitle.textContent = `Informasi Kelas ${classInfo.name.toUpperCase()}`;
                    renderSchedule(studentScheduleTable, false, data.schedule_data);
                    renderPiketSchedule(studentPiketTable, false, data.piket_data);
                    renderOrganisasi(studentOrganisasiContainer, false, data.organization_data);
                    // Setup realtime listener
                    subscribeToChanges(classInfo.id);
                    showPage(studentDashboard);
                }
            }
            
            async function showClassSelection() {
                if (realtimeChannel) {
                    await db.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }
                currentClass = null;
                sessionStorage.removeItem('selectedClassId');
                notificationArea.classList.add('hidden');
                classButtonsContainer.innerHTML = '<p>Memuat kelas...</p>';
                
                const { data: classes, error } = await db.from('classes').select('*');
                if (error) {
                    showToast('Gagal memuat daftar kelas.', 'error');
                    console.error(error);
                    return;
                }

                classButtonsContainer.innerHTML = '';
                classes.forEach(cls => {
                    const button = document.createElement('button');
                    button.textContent = `Kelas ${cls.name.toUpperCase()}`;
                    button.className = 'w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold';
                    button.addEventListener('click', () => showDashboard(cls));
                    classButtonsContainer.appendChild(button);
                });
                showPage(classSelectionPage);
            }

            function subscribeToChanges(classId) {
                // Unsubscribe from any previous channel first
                if (realtimeChannel) db.removeChannel(realtimeChannel);
                
                realtimeChannel = db.channel(`class_data_${classId}`)
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'class_data', filter: `class_id=eq.${classId}` }, payload => {
                        console.log('Perubahan terdeteksi:', payload.new);
                        notificationArea.classList.remove('hidden');
                        showToast('Informasi kelas telah diperbarui!');
                        
                        // Update UI with new data
                        const newData = payload.new;
                        currentClass.data = newData; // Update local state
                        renderSchedule(studentScheduleTable, false, newData.schedule_data);
                        renderPiketSchedule(studentPiketTable, false, newData.piket_data);
                        renderOrganisasi(studentOrganisasiContainer, false, newData.organization_data);

                    })
                    .subscribe();
            }

            async function handleAddStudent(event) {
                event.preventDefault();
                studentFormError.textContent = '';
                const fullname = document.getElementById('student-fullname').value.trim();
                const username = document.getElementById('student-username').value.trim();
                const password = document.getElementById('student-password').value.trim();

                if (!fullname || !username || !password) {
                    studentFormError.textContent = 'Semua field harus diisi.'; return;
                }

                const { error } = await db.from('users').insert([{ fullname, username, password, role: 'siswa' }]);
                if (error) {
                    if (error.code === '23505') { // Unique constraint violation
                        studentFormError.textContent = 'Username sudah digunakan.';
                    } else {
                        studentFormError.textContent = 'Gagal menambahkan siswa.';
                        console.error(error);
                    }
                } else {
                    showToast('Siswa baru berhasil ditambahkan.');
                    addStudentForm.reset();
                    await renderStudentManagement();
                }
            }

            async function handleDeleteStudent(event) {
                const usernameToDelete = event.target.dataset.username;
                const { error } = await db.from('users').delete().eq('username', usernameToDelete);
                if (error) {
                    showToast('Gagal menghapus siswa.', 'error');
                    console.error(error);
                } else {
                    showToast('Data siswa berhasil dihapus.');
                    await renderStudentManagement();
                }
            }

            // --- Event Listeners ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;
                loginError.textContent = '';

                const { data, error } = await db.from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single(); // .single() will error if more than one or no user found

                if (data && !error) {
                    currentUser = data;
                    sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                    await showClassSelection();
                    loginForm.reset();
                } else {
                    loginError.textContent = 'Username atau password salah.';
                }
            });

            addStudentForm.addEventListener('submit', handleAddStudent);
            saveScheduleBtn.addEventListener('click', saveAdminChanges);
            [selectionLogoutBtn, adminLogoutBtn, studentLogoutBtn].forEach(btn => btn.addEventListener('click', logout));
            [adminBackToSelectionBtn, studentBackToSelectionBtn].forEach(btn => btn.addEventListener('click', showClassSelection));

            // --- Initial Check on page load ---
            async function initializeApp() {
                 if (SUPABASE_URL.includes('ANDA') || SUPABASE_ANON_KEY.includes('ANDA')) {
                    appContainer.innerHTML = `
                        <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                            <h1 class="text-2xl font-bold text-red-600 mb-4">Konfigurasi Supabase Diperlukan</h1>
                            <p class="text-gray-700">Silakan buka file <code class="bg-gray-200 p-1 rounded">index.html</code> dan ganti nilai <code class="bg-gray-200 p-1 rounded">SUPABASE_URL</code> dan <code class="bg-gray-200 p-1 rounded">SUPABASE_ANON_KEY</code> dengan kredensial dari proyek Supabase Anda.</p>
                        </div>
                    `;
                    return;
                }
                
                // Inisialisasi klien Supabase HANYA jika kredensial sudah diisi
                db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                const userFromSession = sessionStorage.getItem('loggedInUser');
                if (userFromSession) {
                    currentUser = JSON.parse(userFromSession);
                    const classIdFromSession = sessionStorage.getItem('selectedClassId');
                    if (classIdFromSession) {
                        const { data: classInfo, error } = await db.from('classes').select('*').eq('id', classIdFromSession).single();
                        if (classInfo && !error) {
                           await showDashboard(classInfo);
                        } else {
                           await showClassSelection();
                        }
                    } else {
                        await showClassSelection();
                    }
                } else {
                    showPage(loginPage);
                }
            }

            initializeApp();
        });
    </script>
</body>
</html>                
