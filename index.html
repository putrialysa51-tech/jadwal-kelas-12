<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penjadwalan Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Impor Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: center;
            vertical-align: top;
        }
        .schedule-table th {
            background-color: #f9fafb;
        }
        .notification-toast {
            animation: slide-in 0.5s forwards, fade-out 0.5s 4.5s forwards;
        }
        @keyframes slide-in {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        @keyframes fade-out {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Container Utama -->
    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">

        <!-- Halaman Login -->
        <div id="login-page" class="w-full max-w-md">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-700">Login Akun</h1>
                    <p class="text-gray-500 mt-2">Selamat datang kembali!</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-600 mb-2">Username</label>
                        <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan username Anda" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-600 mb-2">Password</label>
                        <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan password Anda" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold">Login</button>
                    <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
                </form>
            </div>
             <p class="text-center text-gray-500 text-xs mt-4">
                &copy;2025 Aplikasi Penjadwalan.
            </p>
        </div>
        
        <!-- Halaman Pilih Kelas -->
        <div id="class-selection-page" class="hidden w-full max-w-md">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-700">Pilih Kelas</h1>
                    <p class="text-gray-500 mt-2">Pilih kelas yang ingin Anda lihat atau edit.</p>
                </div>
                <div id="class-buttons-container" class="space-y-4">
                    <!-- Tombol kelas akan dibuat oleh JS -->
                </div>
                <button id="selection-logout-btn" class="mt-8 w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-300 font-semibold">Logout</button>
            </div>
        </div>


        <!-- Dashboard Admin -->
        <div id="admin-dashboard" class="hidden w-full max-w-6xl">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <header class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b gap-4">
                    <h2 id="admin-dashboard-title" class="text-2xl font-bold text-gray-700">Dashboard Admin</h2>
                    <div>
                        <button id="admin-back-to-selection-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300 text-sm font-medium">Pilih Kelas Lain</button>
                        <button id="admin-logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 text-sm font-medium ml-2">Logout</button>
                    </div>
                </header>
                
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Kelola Data Siswa</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-8">
                    <form id="add-student-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="student-fullname" class="block text-sm font-medium text-gray-600 mb-1">Nama Lengkap</label>
                            <input type="text" id="student-fullname" placeholder="Contoh: Budi Santoso" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <div>
                            <label for="student-username" class="block text-sm font-medium text-gray-600 mb-1">Username</label>
                            <input type="text" id="student-username" placeholder="Contoh: budi" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <div>
                            <label for="student-password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                            <input type="text" id="student-password" placeholder="Password untuk siswa" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold text-sm h-10">Tambah Siswa</button>
                    </form>
                    <p id="student-form-error" class="text-red-500 text-sm mt-2"></p>
                    <div class="overflow-x-auto mt-4">
                        <table class="w-full schedule-table text-sm">
                              <thead>
                                <tr>
                                    <th>Nama Lengkap</th>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body">
                                <!-- Daftar siswa akan di-generate oleh JS -->
                            </tbody>
                        </table>
                    </div>
                </div>


                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Pelajaran</h3>
                <div class="overflow-x-auto mb-4"> <!-- Diubah dari mb-8 -->
                    <table class="w-full schedule-table" id="admin-schedule-table"></table>
                </div>
                <!-- Tombol Simpan untuk Jadwal Pelajaran -->
                <div class="text-right mb-8">
                    <button id="save-schedule-only-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold text-sm">Simpan Jadwal Pelajaran</button>
                </div>

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Piket</h3>
                 <!-- Form Tambah Piket Baru -->
                 <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <form id="add-piket-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="piket-name" class="block text-sm font-medium text-gray-600 mb-1">Nama Siswa</label>
                            <input type="text" id="piket-name" placeholder="Contoh: Budi" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <div>
                            <label for="piket-day" class="block text-sm font-medium text-gray-600 mb-1">Hari</label>
                            <select id="piket-day" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white" required>
                                <option value="Senin">Senin</option>
                                <option value="Selasa">Selasa</option>
                                <option value="Rabu">Rabu</option>
                                <option value="Kamis">Kamis</option>
                                <option value="Jumat">Jumat</option>
                            </select>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold text-sm h-10">Tambah Piket</button>
                    </form>
                </div>
                 <div class="overflow-x-auto mb-4"> <!-- Diubah dari mb-8 -->
                    <table class="w-full schedule-table" id="admin-piket-table"></table>
                </div>
                <!-- Tombol Simpan untuk Jadwal Piket -->
                <div class="text-right mb-8">
                    <button id="save-piket-only-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold text-sm">Simpan Jadwal Piket</button>
                </div>

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Struktur Organisasi Kelas</h3>
                <div id="admin-organisasi-container" class="bg-gray-50 p-4 rounded-lg"></div>
                <!-- Tombol Simpan untuk Struktur Organisasi -->
                <div class="text-right mt-4">
                    <button id="save-org-only-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold text-sm">Simpan Struktur Organisasi</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Guru (BARU) -->
        <div id="teacher-dashboard" class="hidden w-full max-w-6xl">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                 <header class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b gap-4">
                    <h2 id="teacher-dashboard-title" class="text-2xl font-bold text-gray-700">Dashboard Guru</h2>
                    <div>
                        <button id="teacher-back-to-selection-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300 text-sm font-medium">Pilih Kelas Lain</button>
                        <button id="teacher-logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 text-sm font-medium ml-2">Logout</button>
                    </div>
                </header>
                <!-- Notifikasi Perubahan Jadwal -->
                <div id="teacher-notification-area" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-6 hidden" role="alert">
                  <p class="font-bold">Pemberitahuan</p>
                  <p id="teacher-notification-message">Jadwal dan info kelas ini baru saja diperbarui oleh admin.</p>
                </div>

                <!-- Bagian Pengingat Tugas Harian (Guru) -->
                <h3 class="text-xl font-semibold text-gray-600 mb-4 mt-8">Pengingat Tugas Harian</h3>
                <div class="bg-gray-50 p-4 rounded-lg mb-8">
                    <form id="teacher-add-task-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-4">
                        <div>
                            <label for="teacher-task-text" class="block text-sm font-medium text-gray-600 mb-1">Tugas Baru</label>
                            <input type="text" id="teacher-task-text" placeholder="Contoh: Kerjakan PR Bab 3" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <div>
                            <label for="teacher-task-due-date" class="block text-sm font-medium text-gray-600 mb-1">Tenggat</label>
                            <input type="date" id="teacher-task-due-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" required>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold text-sm h-10">Tambah Tugas</button>
                    </form>
                    <div id="teacher-task-list-container" class="space-y-2">
                        <!-- Daftar tugas admin akan dirender di sini -->
                    </div>
                </div>
                <!-- Tombol Simpan untuk Tugas Harian -->
                <div class="text-right mb-8">
                    <button id="save-tasks-only-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold text-sm">Simpan Tugas Harian</button>
                </div>
                <!-- Akhir Bagian Pengingat Tugas Harian (Guru) -->

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Pelajaran (Read-Only)</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full schedule-table" id="teacher-schedule-table"></table>
                </div>
                
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Piket (Read-Only)</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full schedule-table" id="teacher-piket-table"></table>
                </div>

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Struktur Organisasi Kelas (Read-Only)</h3>
                <div id="teacher-organisasi-container" class="bg-gray-50 p-4 rounded-lg"></div>
            </div>
        </div>

        <!-- Dashboard Siswa -->
        <div id="student-dashboard" class="hidden w-full max-w-6xl">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                 <header class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b gap-4">
                    <h2 id="student-dashboard-title" class="text-2xl font-bold text-gray-700">Informasi Kelas</h2>
                    <div>
                        <button id="student-back-to-selection-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-300 text-sm font-medium">Pilih Kelas Lain</button>
                        <button id="student-logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300 text-sm font-medium ml-2">Logout</button>
                    </div>
                </header>
                <!-- Notifikasi Perubahan Jadwal -->
                <div id="notification-area" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md mb-6 hidden" role="alert">
                  <p class="font-bold">Pemberitahuan</p>
                  <p id="notification-message">Jadwal dan info kelas ini baru saja diperbarui oleh admin.</p>
                </div>

                <!-- Bagian Pengingat Tugas Harian (Siswa) - DIKEMBALIKAN -->
                <h3 class="text-xl font-semibold text-gray-600 mb-4 mt-8">Pengingat Tugas Harian</h3>
                <div id="student-task-list-container" class="bg-gray-50 p-4 rounded-lg space-y-3 mb-8">
                    <!-- Daftar tugas siswa akan dirender di sini -->
                </div>
                <!-- Akhir Bagian Pengingat Tugas Harian (Siswa) -->

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Pelajaran</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full schedule-table" id="student-schedule-table"></table>
                </div>
                
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Jadwal Piket</h3>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full schedule-table" id="student-piket-table"></table>
                </div>

                <h3 class="text-xl font-semibold text-gray-600 mb-4">Struktur Organisasi Kelas</h3>
                <div id="student-organisasi-container" class="bg-gray-50 p-4 rounded-lg"></div>

            </div>
        </div>

    </div>

    <!-- Container untuk notifikasi toast -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GANTI DENGAN KUNCI SUPABASE ANDA ---
            const SUPABASE_URL = 'https://uhywvvlofvmdnmjwdmcu.supabase.co'; // Ganti dengan URL Proyek Anda
            
            // KUNCI SEBELUMNYA TIDAK VALID. HARAP SALIN KEMBALI KUNCI DARI DASHBOARD SUPABASE ANDA.
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoeXd2dmxvZnZtZG5tandkbWN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0Nzk5NzAsImV4cCI6MjA3NjA1NTk3MH0.OUUFKGviz-qqLcS6kVkX0HEZcFPJ_Rj3OJQhUBg1jeg'; // Ganti dengan Kunci Anon Anda
            
            // --- State Aplikasi ---
            let db; // Akan diinisialisasi nanti
            const { createClient } = supabase;
            let currentUser = null;
            let currentClass = null;
            let realtimeChannel = null;

            // Definisikan urutan hari yang benar
            const orderedDays = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];

            // --- DOM Elements ---
            const appContainer = document.getElementById('app-container');
            const loginPage = document.getElementById('login-page');
            const classSelectionPage = document.getElementById('class-selection-page');
            const adminDashboard = document.getElementById('admin-dashboard');
            const studentDashboard = document.getElementById('student-dashboard');
            const teacherDashboard = document.getElementById('teacher-dashboard'); // BARU
            
            const loginForm = document.getElementById('login-form');
            const addStudentForm = document.getElementById('add-student-form');
            const classButtonsContainer = document.getElementById('class-buttons-container');
            const loginError = document.getElementById('login-error');
            const studentFormError = document.getElementById('student-form-error');
            
            const selectionLogoutBtn = document.getElementById('selection-logout-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const studentLogoutBtn = document.getElementById('student-logout-btn');
            const teacherLogoutBtn = document.getElementById('teacher-logout-btn'); // BARU
            
            const adminBackToSelectionBtn = document.getElementById('admin-back-to-selection-btn');
            const studentBackToSelectionBtn = document.getElementById('student-back-to-selection-btn');
            const teacherBackToSelectionBtn = document.getElementById('teacher-back-to-selection-btn'); // BARU
            
            // Admin tables
            const adminScheduleTable = document.getElementById('admin-schedule-table');
            const adminPiketTable = document.getElementById('admin-piket-table');
            const adminOrganisasiContainer = document.getElementById('admin-organisasi-container');
            const studentListBody = document.getElementById('student-list-body');
            
            // Student tables
            const studentScheduleTable = document.getElementById('student-schedule-table');
            const studentPiketTable = document.getElementById('student-piket-table');
            const studentOrganisasiContainer = document.getElementById('student-organisasi-container');

            // Teacher tables (read-only) & elements
            const teacherScheduleTable = document.getElementById('teacher-schedule-table'); // BARU
            const teacherPiketTable = document.getElementById('teacher-piket-table'); // BARU
            const teacherOrganisasiContainer = document.getElementById('teacher-organisasi-container'); // BARU
            const teacherDashboardTitle = document.getElementById('teacher-dashboard-title'); // BARU
            const teacherNotificationArea = document.getElementById('teacher-notification-area'); // BARU
            
            const adminDashboardTitle = document.getElementById('admin-dashboard-title');
            const studentDashboardTitle = document.getElementById('student-dashboard-title');
            const notificationArea = document.getElementById('notification-area');
            const toastContainer = document.getElementById('toast-container');
            
            // Tombol Simpan Admin
            const saveScheduleOnlyBtn = document.getElementById('save-schedule-only-btn');
            const savePiketOnlyBtn = document.getElementById('save-piket-only-btn');
            const saveOrgOnlyBtn = document.getElementById('save-org-only-btn');

            // DOM Elements untuk Tugas Harian (DIKEMBALIKAN)
            const teacherAddTaskForm = document.getElementById('teacher-add-task-form'); // BARU
            const teacherTaskListContainer = document.getElementById('teacher-task-list-container'); // BARU
            const studentTaskListContainer = document.getElementById('student-task-list-container'); // BARU
            const saveTasksOnlyBtn = document.getElementById('save-tasks-only-btn'); // BARU


            // --- Functions ---
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                toast.className = `notification-toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.remove(); }, 5000);
            }
            
            async function renderStudentManagement() {
// ... (Fungsi ini tidak berubah) ...
                studentListBody.innerHTML = '<tr><td colspan="4" class="p-4">Memuat data...</td></tr>';
                const { data: students, error } = await db.from('users').select('*').eq('role', 'siswa');
                if (error) {
                    showToast('Gagal memuat data siswa.', 'error');
                    console.error(error);
                    return;
                }
                studentListBody.innerHTML = '';
                students.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2 border">${student.fullname}</td>
                        <td class="p-2 border">${student.username}</td>
                        <td class="p-2 border">${student.password}</td>
                        <td class="p-2 border">
                            <button data-username="${student.username}" class="delete-student-btn bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600">Hapus</button>
                        </td>
                    `;
                    studentListBody.appendChild(tr);
                });
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', handleDeleteStudent);
                });
            }

            function renderSchedule(tableElement, isAdmin, scheduleData) {
// ... (Fungsi ini tidak berubah) ...
                if (!scheduleData) {
                     tableElement.innerHTML = '<tbody><tr><td class="p-4">Data jadwal tidak tersedia.</td></tr></tbody>'; return;
                }
                const days = orderedDays; 
                if (days.length === 0) {
                    tableElement.innerHTML = '<tbody><tr><td class="p-4">Jadwal belum diatur.</td></tr></tbody>'; return;
                }
                const times = Object.keys(scheduleData[days[0]] || {}).sort();
                if (times.length === 0) { tableElement.innerHTML = '<tbody><tr><td class="p-4">Jadwal belum diatur.</td></tr></tbody>'; return; }
                let html = '<thead><tr><th class="w-1/12">Waktu</th>';
                days.forEach(day => html += `<th>${day}</th>`);
                html += '</tr></thead><tbody>';
                times.forEach(time => {
                    html += `<tr>`;
                    if (isAdmin) {
                        html += `<td><input type="text" value="${time}" class="w-full text-center border rounded px-1 font-semibold text-sm" data-old-time="${time}"></td>`;
                    } else {
                        html += `<td class="font-semibold text-sm">${time}</td>`;
                    }
                    days.forEach(day => {
                        const cellData = scheduleData[day]?.[time] || { subject: '', teacher: '' };
                        if (isAdmin) {
                            html += `<td>
                                <input type="text" value="${cellData.subject}" class="w-full text-center border rounded px-1 text-sm" data-day="${day}" data-time="${time}" data-field="subject" placeholder="Pelajaran">
                                <input type="text" value="${cellData.teacher}" class="w-full text-center border rounded px-1 mt-1 text-xs text-gray-600" data-day="${day}" data-time="${time}" data-field="teacher" placeholder="Guru">
                            </td>`;
                        } else {
                            html += `<td>
                                <div class="font-semibold text-sm">${cellData.subject}</div>
                                <div class="text-xs text-gray-500">${cellData.teacher}</div>
                            </td>`;
                        }
                    });
                    html += '</tr>';
                });
                html += '</tbody>';
                tableElement.innerHTML = html;
            }

            function renderPiketSchedule(tableElement, isAdmin, piketData) {
// ... (Fungsi ini tidak berubah, event listener dipasang di akhir) ...
                 if (!piketData) {
                     tableElement.innerHTML = '<tbody><tr><td class="p-4">Data piket tidak tersedia.</td></tr></tbody>'; return;
                }
                const days = orderedDays; 
                
                let html = '<thead><tr><th class="w-1/6">Hari</th><th>Nama Siswa</th></tr></thead><tbody>';
                
                days.forEach(day => {
                    const names = piketData[day] || '';
                    html += '<tr>';
                    html += `<td class="font-semibold">${day}</td>`; 
                    
                    if (isAdmin) {
                        let namesListHtml = '<div class="space-y-1 text-left">';
                        if (names) {
                            names.split('\n').forEach(name => {
                                if (name.trim()) {
                                    namesListHtml += `
                                        <div class="flex justify-between items-center bg-white p-1.5 rounded border">
                                            <span>${name}</span>
                                            <button data-day="${day}" data-name="${name}" class="delete-piket-btn bg-red-500 text-white px-2 py-0.5 rounded text-xs hover:bg-red-600">Hapus</button>
                                        </div>
                                    `;
                                }
                            });
                        } else {
                            namesListHtml += '<span class="text-xs text-gray-500">Belum ada siswa</span>';
                        }
                        namesListHtml += '</div>';
                        html += `<td>${namesListHtml}</td>`;

                    } else {
                        html += `<td class="text-sm leading-relaxed text-left">${names.replace(/\n/g, '<br>')}</td>`;
                    }
                    html += '</tr>';
                });
                html += '</tbody>';
                tableElement.innerHTML = html;

                if (isAdmin) {
                    document.querySelectorAll('.delete-piket-btn').forEach(btn => {
                        btn.addEventListener('click', handleDeletePiket);
                    });
                }
            }

            function renderOrganisasi(containerElement, isAdmin, organisasiData) {
// ... (Fungsi ini tidak berubah) ...
                 if (!organisasiData) {
                     containerElement.innerHTML = '<p>Data organisasi tidak tersedia.</p>'; return;
                }
                const positions = [ { id: 'ketua', label: 'Ketua Kelas' }, { id: 'wakil', label: 'Wakil Ketua Kelas' }, { id: 'sekretaris1', label: 'Sekretaris 1' }, { id: 'sekretaris2', label: 'Sekretaris 2' }, { id: 'bendahara1', label: 'Bendahara 1' }, { id: 'bendahara2', label: 'Bendahara 2' }, { id: 'kesenian1', label: 'Seksi Kesenian 1' }, { id: 'kesenian2', label: 'Seksi Kesenian 2' }, { id: 'pendidikan1', label: 'Seksi Pendidikan 1' }, { id: 'pendidikan2', label: 'Seksi Pendidikan 2' }, { id: 'kebersihan1', label: 'Seksi Kebersihan 1' }, { id: 'kebersihan2', label: 'Seksi Kebersihan 2' }];
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                positions.forEach(pos => {
                    const name = organisasiData[pos.id] || '';
                    html += `<div class="bg-white p-3 rounded-lg border">`;
                    if (isAdmin) {
                        html += `
                            <label for="org-${pos.id}" class="block text-sm font-medium text-gray-600">${pos.label}</label>
                            <input type="text" id="org-${pos.id}" data-position="${pos.id}" value="${name}" class="mt-1 w-full px-2 py-1 border border-gray-300 rounded-md text-sm">
                        `;
                    } else {
                        html += `
                            <p class="text-sm font-medium text-gray-600">${pos.label}</p>
                            <p class="font-semibold text-gray-800">${name || '-'}</p>
                        `;
                    }
                    html += `</div>`;
                });
                html += '</div>';
                containerElement.innerHTML = html;
            }

            // --- Fungsi untuk Tugas Harian (DIKEMBALIKAN) ---

            // Render tasks for Admin/Teacher (dengan tombol hapus)
            function renderAdminTasks(tasks, container) {
                container.innerHTML = '';
                if (!tasks || tasks.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Belum ada tugas.</p>';
                    return;
                }
                tasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.className = 'flex justify-between items-center bg-white p-2 rounded border';
                    taskEl.innerHTML = `
                        <div>
                            <p class="font-medium">${task.text}</p>
                            <p class="text-xs text-gray-500">Tenggat: ${task.dueDate}</p>
                        </div>
                        <button data-task-id="${task.id}" class="delete-task-btn bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">Hapus</button>
                    `;
                    container.appendChild(taskEl);
                });
                container.querySelectorAll('.delete-task-btn').forEach(btn => btn.addEventListener('click', handleDeleteTask));
            }

            // Render tasks for Student (dengan checkbox)
            function renderStudentTasks(tasks, container) {
                container.innerHTML = '';
                if (!tasks || tasks.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500">Tidak ada tugas harian. Hore!</p>';
                    return;
                }
                const doneTasks = JSON.parse(localStorage.getItem(`doneTasks_${currentClass.id}`)) || [];
                tasks.forEach(task => {
                    const isDone = doneTasks.includes(task.id);
                    const taskEl = document.createElement('div');
                    taskEl.className = 'flex items-center';
                    taskEl.innerHTML = `
                        <input type="checkbox" id="task-${task.id}" data-task-id="${task.id}" class="student-task-cb h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${isDone ? 'checked' : ''}>
                        <label for="task-${task.id}" class="ml-2 ${isDone ? 'line-through text-gray-400' : ''}">
                            <span class="font-medium">${task.text}</span>
                            <span class="text-xs text-gray-500 ml-1">(Tenggat: ${task.dueDate})</span>
                        </label>
                    `;
                    container.appendChild(taskEl);
                });
                container.querySelectorAll('.student-task-cb').forEach(cb => cb.addEventListener('change', handleToggleTask));
            }

            // Dipanggil oleh form guru
            function handleAddTask(event) {
                event.preventDefault();
                const taskText = document.getElementById('teacher-task-text').value.trim();
                const taskDueDate = document.getElementById('teacher-task-due-date').value;
                if (!taskText || !taskDueDate) {
                    showToast('Tugas dan tenggat tidak boleh kosong.', 'error');
                    return;
                }
                const newTask = {
                    id: `task_${Date.now()}`, // Buat ID unik sederhana
                    text: taskText,
                    dueDate: taskDueDate
                };
                if (!currentClass.data.tugas_data) {
                    currentClass.data.tugas_data = [];
                }
                currentClass.data.tugas_data.push(newTask);
                renderAdminTasks(currentClass.data.tugas_data, teacherTaskListContainer); // Render di list guru
                teacherAddTaskForm.reset();
                showToast('Tugas ditambahkan. Klik "Simpan Tugas" untuk menyimpan.', 'success');
            }

            // Dipanggil oleh tombol hapus guru
            function handleDeleteTask(event) {
                const taskId = event.target.dataset.taskId;
                currentClass.data.tugas_data = currentClass.data.tugas_data.filter(task => task.id !== taskId);
                renderAdminTasks(currentClass.data.tugas_data, teacherTaskListContainer); // Render di list guru
                showToast('Tugas dihapus. Klik "Simpan Tugas" untuk menyimpan.', 'success');
            }

            // Dipanggil oleh checkbox siswa
            function handleToggleTask(event) {
                const taskId = event.target.dataset.taskId;
                const isDone = event.target.checked;
                const storageKey = `doneTasks_${currentClass.id}`;
                let doneTasks = JSON.parse(localStorage.getItem(storageKey)) || [];
                
                if (isDone) {
                    if (!doneTasks.includes(taskId)) {
                        doneTasks.push(taskId);
                    }
                } else {
                    doneTasks = doneTasks.filter(id => id !== taskId);
                }
                localStorage.setItem(storageKey, JSON.stringify(doneTasks));
                
                // Panggil render lagi untuk update tampilan (coretan)
                renderStudentTasks(currentClass.data.tugas_data, studentTaskListContainer);
            }
            // --- Akhir Fungsi Tugas Harian ---


            // --- Fungsi Piket (Tidak Berubah) ---
            function handleAddPiket(event) {
// ... (Fungsi ini tidak berubah) ...
                event.preventDefault();
                const name = document.getElementById('piket-name').value.trim();
                const day = document.getElementById('piket-day').value;

                if (!name) return;

                const currentNames = currentClass.data.piket_data[day] || '';
                const namesArray = currentNames ? currentNames.split('\n') : [];
                
                if (namesArray.includes(name)) {
                    showToast('Nama siswa sudah ada di hari tersebut.', 'error');
                    return;
                }

                namesArray.push(name);
                currentClass.data.piket_data[day] = namesArray.join('\n');
                
                renderPiketSchedule(adminPiketTable, true, currentClass.data.piket_data);
                document.getElementById('add-piket-form').reset();
                showToast('Nama ditambahkan. Klik "Simpan Perubahan" untuk menyimpan.', 'success');
            }

            function handleDeletePiket(event) {
// ... (Fungsi ini tidak berubah) ...
                const name = event.target.dataset.name;
                const day = event.target.dataset.day;

                const currentNames = currentClass.data.piket_data[day] || '';
                let namesArray = currentNames.split('\n');
                
                namesArray = namesArray.filter(n => n !== name); // Hapus nama
                
                currentClass.data.piket_data[day] = namesArray.join('\n');

                renderPiketSchedule(adminPiketTable, true, currentClass.data.piket_data);
                showToast('Nama dihapus. Klik "Simpan Perubahan" untuk menyimpan.', 'success');
            }
            // --- Akhir Fungsi Piket ---

            // --- Fungsi Simpan (Dipecah) ---
            async function saveScheduleChanges() {
// ... (Fungsi ini tidak berubah) ...
                if (!currentClass) return;
                
                const newScheduleData = {};
                const days = orderedDays; 
                const timeInputs = adminScheduleTable.querySelectorAll('input[data-old-time]');
                timeInputs.forEach(timeInput => {
                    const oldTime = timeInput.dataset.oldTime;
                    const newTime = timeInput.value.trim();
                    if (!newTime) return;
                    days.forEach(day => {
                        const subjectInput = adminScheduleTable.querySelector(`input[data-day="${day}"][data-time="${oldTime}"][data-field="subject"]`);
                        const teacherInput = adminScheduleTable.querySelector(`input[data-day="${day}"][data-time="${oldTime}"][data-field="teacher"]`);
                        if (subjectInput && teacherInput) {
                            if (!newScheduleData[day]) newScheduleData[day] = {};
                            newScheduleData[day][newTime] = { subject: subjectInput.value, teacher: teacherInput.value };
                        }
                    });
                });
                
                const { error } = await db.from('class_data')
                    .update({ schedule_data: newScheduleData })
                    .eq('class_id', currentClass.id);

                if (error) {
                    showToast('Gagal menyimpan jadwal pelajaran.', 'error');
                    console.error(error);
                } else {
                    showToast('Jadwal pelajaran berhasil disimpan!');
                    currentClass.data.schedule_data = newScheduleData;
                }
            }

            async function savePiketChanges() {
// ... (Fungsi ini tidak berubah) ...
                if (!currentClass) return;
                const newPiketData = currentClass.data.piket_data; 
                
                const { error } = await db.from('class_data')
                    .update({ piket_data: newPiketData })
                    .eq('class_id', currentClass.id);

                if (error) {
                    showToast('Gagal menyimpan jadwal piket.', 'error');
                    console.error(error);
                } else {
                    showToast('Jadwal piket berhasil disimpan!');
                }
            }

            async function saveOrgChanges() {
// ... (Fungsi ini tidak berubah) ...
                if (!currentClass) return;
                const newOrganisasiData = {};
                adminOrganisasiContainer.querySelectorAll('input').forEach(input => { newOrganisasiData[input.dataset.position] = input.value; });

                const { error } = await db.from('class_data')
                    .update({ organization_data: newOrganisasiData })
                    .eq('class_id', currentClass.id);

                if (error) {
                    showToast('Gagal menyimpan struktur organisasi.', 'error');
                    console.error(error);
                } else {
                    showToast('Struktur organisasi berhasil disimpan!');
                    currentClass.data.organization_data = newOrganisasiData;
                }
            }

            // Fungsi Simpan Baru untuk Tugas
            async function saveTaskChanges() {
                if (!currentClass) return;

                const newTugasData = currentClass.data.tugas_data || []; // Ambil data tugas
                
                const { error } = await db.from('class_data')
                    .update({ tugas_data: newTugasData })
                    .eq('class_id', currentClass.id);

                if (error) {
                    showToast('Gagal menyimpan tugas harian.', 'error');
                    console.error(error);
                } else {
                    showToast('Tugas harian berhasil disimpan!');
                }
            }
            
            function showPage(page) {
                [loginPage, classSelectionPage, adminDashboard, studentDashboard, teacherDashboard].forEach(p => p.classList.add('hidden')); // Tambahkan teacherDashboard
                if (page) page.classList.remove('hidden');
            }
            
            async function logout() {
// ... (Fungsi ini tidak berubah) ...
                if (realtimeChannel) {
                    await db.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }
                currentUser = null;
                currentClass = null;
                sessionStorage.clear();
                showPage(loginPage);
            }
            
            async function showDashboard(classInfo) {
                currentClass = classInfo;
                sessionStorage.setItem('selectedClassId', classInfo.id);

                // Fetch the detailed class data
                const { data, error } = await db.from('class_data')
                    .select('*')
                    .eq('class_id', classInfo.id)
                    .single(); // We expect only one row

                if (error || !data) {
                    // ... (Error handling tidak berubah) ...
                    if (error && error.code === 'PGRST205') {
                        appContainer.innerHTML = `
                            <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                                <h1 class="text-2xl font-bold text-red-600 mb-4">Error: Tabel Tidak Ditemukan</h1>
                                <p class="text-gray-700 mb-2">Aplikasi tidak dapat menemukan tabel <code class="bg-gray-200 p-1 rounded">'class_data'</code> di database Anda.</p>
                                <p class="text-gray-700">Pastikan Anda telah menjalankan skrip SQL dari file <code class="bg-gray-200 p-1 rounded">supabase_setup_guide.md</code> di <strong>SQL Editor</strong> Supabase untuk membuat semua tabel yang diperlukan.</p>
                            </div>
                        `;
                        return;
                    }
                    showToast('Gagal memuat data kelas.', 'error');
                    console.error(error);
                    return;
                }
                currentClass.data = data; // Store detailed data

                // Logika routing berdasarkan peran
                if (currentUser.role === 'admin') {
                    adminDashboardTitle.textContent = `Dashboard Admin - Kelas ${classInfo.name.toUpperCase()}`;
                    await renderStudentManagement();
                    renderSchedule(adminScheduleTable, true, data.schedule_data);
                    renderPiketSchedule(adminPiketTable, true, data.piket_data);
                    renderOrganisasi(adminOrganisasiContainer, true, data.organization_data);
                    showPage(adminDashboard);
                } else if (currentUser.role === 'guru') {
                    // Tampilkan Dashboard Guru
                    teacherDashboardTitle.textContent = `Dashboard Guru - Kelas ${classInfo.name.toUpperCase()}`;
                    // Render read-only views
                    renderSchedule(teacherScheduleTable, false, data.schedule_data);
                    renderPiketSchedule(teacherPiketTable, false, data.piket_data);
                    renderOrganisasi(teacherOrganisasiContainer, false, data.organization_data);
                    // Render task management
                    renderAdminTasks(data.tugas_data || [], teacherTaskListContainer);
                    subscribeToChanges(classInfo.id, teacherNotificationArea); // Notifikasi untuk guru
                    showPage(teacherDashboard);
                } else {
                    // Tampilkan Dashboard Siswa
                    studentDashboardTitle.textContent = `Informasi Kelas ${classInfo.name.toUpperCase()}`;
                    renderSchedule(studentScheduleTable, false, data.schedule_data);
                    renderPiketSchedule(studentPiketTable, false, data.piket_data);
                    renderOrganisasi(studentOrganisasiContainer, false, data.organization_data);
                    renderStudentTasks(data.tugas_data || [], studentTaskListContainer); // Render tugas siswa
                    subscribeToChanges(classInfo.id, notificationArea); // Notifikasi untuk siswa
                    showPage(studentDashboard);
                }
            }
            
            async function showClassSelection() {
// ... (Fungsi ini tidak berubah) ...
                if (realtimeChannel) {
                    await db.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                }
                currentClass = null;
                sessionStorage.removeItem('selectedClassId');
                notificationArea.classList.add('hidden');
                classButtonsContainer.innerHTML = '<p>Memuat kelas...</p>';
                
                const { data: classes, error } = await db.from('classes').select('*');
                if (error) {
                    showToast('Gagal memuat daftar kelas.', 'error');
                    console.error(error);
                    return;
                }

                classButtonsContainer.innerHTML = '';
                classes.forEach(cls => {
                    const button = document.createElement('button');
                    button.textContent = `Kelas ${cls.name.toUpperCase()}`;
                    button.className = 'w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold';
                    button.addEventListener('click', () => showDashboard(cls));
                    classButtonsContainer.appendChild(button);
                });
                showPage(classSelectionPage);
            }

            function subscribeToChanges(classId, notifAreaElement) { // Tambah parameter notifAreaElement
                // Unsubscribe from any previous channel first
                if (realtimeChannel) db.removeChannel(realtimeChannel);
                
                realtimeChannel = db.channel(`class_data_${classId}`)
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'class_data', filter: `class_id=eq.${classId}` }, payload => {
                        console.log('Perubahan terdeteksi:', payload.new);
                        if(notifAreaElement) notifAreaElement.classList.remove('hidden'); // Tampilkan notifikasi
                        showToast('Informasi kelas telah diperbarui!');
                        
                        // Update UI with new data
                        const newData = payload.new;
                        currentClass.data = newData; // Update local state
                        
                        // Update dashboard yang sedang aktif
                        if (currentUser.role === 'guru') {
                            renderSchedule(teacherScheduleTable, false, newData.schedule_data);
                            renderPiketSchedule(teacherPiketTable, false, newData.piket_data);
                            renderOrganisasi(teacherOrganisasiContainer, false, newData.organization_data);
                            // Guru tidak perlu update task list real-time karena mereka yg mengedit
                        } else if (currentUser.role === 'siswa') {
                            renderSchedule(studentScheduleTable, false, newData.schedule_data);
                            renderPiketSchedule(studentPiketTable, false, newData.piket_data);
                            renderOrganisasi(studentOrganisasiContainer, false, newData.organization_data);
                            renderStudentTasks(newData.tugas_data || [], studentTaskListContainer); // Update tugas siswa
                        }
                    })
                    .subscribe();
            }

            async function handleAddStudent(event) {
// ... (Fungsi ini tidak berubah) ...
                event.preventDefault();
                studentFormError.textContent = '';
                const fullname = document.getElementById('student-fullname').value.trim();
                const username = document.getElementById('student-username').value.trim();
                const password = document.getElementById('student-password').value.trim();

                if (!fullname || !username || !password) {
                    studentFormError.textContent = 'Semua field harus diisi.'; return;
                }

                const { error } = await db.from('users').insert([{ fullname, username, password, role: 'siswa' }]);
                if (error) {
                    if (error.code === '23505') { // Unique constraint violation
                        studentFormError.textContent = 'Username sudah digunakan.';
                    } else {
                        studentFormError.textContent = 'Gagal menambahkan siswa.';
                        console.error(error);
                    }
                } else {
                    showToast('Siswa baru berhasil ditambahkan.');
                    addStudentForm.reset();
                    await renderStudentManagement();
                }
            }

            async function handleDeleteStudent(event) {
// ... (Fungsi ini tidak berubah) ...
                const usernameToDelete = event.target.dataset.username;
                const { error } = await db.from('users').delete().eq('username', usernameToDelete);
                if (error) {
                    showToast('Gagal menghapus siswa.', 'error');
                    console.error(error);
                } else {
                    showToast('Data siswa berhasil dihapus.');
                    await renderStudentManagement();
                }
            }

            // --- Event Listeners ---
            loginForm.addEventListener('submit', async (e) => {
// ... (Logika tidak berubah, 'guru' akan masuk ke 'else' block) ...
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;
                loginError.textContent = '';

                const { data, error } = await db.from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single(); 

                if (data && !error) {
                    currentUser = data;
                    sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                    
                    if (currentUser.role === 'admin') {
                        const { data: classes, error: classError } = await db.from('classes').select('*').limit(1);
                        if (classError || !classes || classes.length === 0) {
                            showToast('Tidak ada data kelas yang ditemukan.', 'error');
                            return;
                        }
                        await showDashboard(classes[0]); 
                    } else {
                        // Siswa dan Guru akan masuk ke pemilihan kelas
                        await showClassSelection();
                    }
                    
                    loginForm.reset();
                } else {
                    loginError.textContent = 'Username atau password salah.';
                }
            });

            addStudentForm.addEventListener('submit', handleAddStudent);
            document.getElementById('add-piket-form').addEventListener('submit', handleAddPiket); 
            teacherAddTaskForm.addEventListener('submit', handleAddTask); // Listener untuk form tugas guru
            
            // Listener untuk tombol simpan
            saveScheduleOnlyBtn.addEventListener('click', saveScheduleChanges);
            savePiketOnlyBtn.addEventListener('click', savePiketChanges);
            saveOrgOnlyBtn.addEventListener('click', saveOrgChanges);
            saveTasksOnlyBtn.addEventListener('click', saveTaskChanges); // Listener untuk simpan tugas

            [selectionLogoutBtn, adminLogoutBtn, studentLogoutBtn, teacherLogoutBtn].forEach(btn => btn.addEventListener('click', logout)); // Tambah teacherLogoutBtn
            [adminBackToSelectionBtn, studentBackToSelectionBtn, teacherBackToSelectionBtn].forEach(btn => btn.addEventListener('click', showClassSelection)); // Tambah teacherBackToSelectionBtn

            // --- Initial Check on page load ---
            async function initializeApp() {
// ... (Logika tidak berubah, 'guru' akan masuk ke 'else' block) ...
                 if (SUPABASE_URL.includes('ANDA') || SUPABASE_ANON_KEY.includes('ANDA')) {
                    appContainer.innerHTML = `
                        <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                            <h1 class="text-2xl font-bold text-red-600 mb-4">Konfigurasi Supabase Diperlukan</h1>
                            <p class="text-gray-700">Silakan buka file <code class="bg-gray-200 p-1 rounded">index.html</code> dan ganti nilai <code class="bg-gray-200 p-1 rounded">SUPABASE_URL</code> dan <code class="bg-gray-200 p-1 rounded">SUPABASE_ANON_KEY</code> dengan kredensial dari proyek Supabase Anda.</p>
                        </div>
                    `;
                    return;
                }
                
                db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                const userFromSession = sessionStorage.getItem('loggedInUser');
                if (userFromSession) {
                    currentUser = JSON.parse(userFromSession);
                    const classIdFromSession = sessionStorage.getItem('selectedClassId');
                    if (classIdFromSession) {
                        const { data: classInfo, error } = await db.from('classes').select('*').eq('id', classIdFromSession).single();
                        if (classInfo && !error) {
                           await showDashboard(classInfo);
                        } else {
                           await showClassSelection();
                        }
                    } else {
                        if (currentUser.role === 'admin') {
                            const { data: classes, error: classError } = await db.from('classes').select('*').limit(1);
                            if (classError || !classes || classes.length === 0) {
                                showToast('Tidak ada data kelas yang ditemukan.', 'error');
                                return;
                            }
                            await showDashboard(classes[0]); 
                        } else {
                            // Siswa dan Guru akan masuk ke pemilihan kelas
                            await showClassSelection();
                        }
                    }
                } else {
                    showPage(loginPage);
                }
            }

            initializeApp();
        });
    </script>
</body>
</html>
